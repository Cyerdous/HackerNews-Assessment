using HackerNews_Assessment.Repositories;
using HackerNews_Assessment.Services;
using Microsoft.Extensions.Logging;
using NSubstitute;
using Xunit;

namespace HackerNews_Assessment.Tests.Services;

public class HackerNewsServiceTests: IDisposable
{
	private readonly ILogger<HackerNewsService> _logger;
	private readonly IHackerNewsRepository _repository;
	const int itemsPerPage = 20;

	public HackerNewsServiceTests()
	{
		_logger = Substitute.For<ILogger<HackerNewsService>>();
		_repository = Substitute.For<IHackerNewsRepository>();
	}

	public void Dispose()
	{

	}

	[Fact]
	public async Task GetStoryCount_ForQuery_ReturnsInt()
	{
		var data = new List<int>{43754762,43754752,43754749,43754748,43754739,43754730,43754700,43754666,43754657,43754652,43754620,43754613,43754609,43754607,43754606,43754568,43754566,43754548,43754534,43754524,43754516,43754492,43754487,43754445,43754439,43754438,43754434,43754426,43754408,43754407,43754396,43754389,43754383,43754368,43754366,43754335,43754319,43754299,43754281,43754280,43754274,43754272,43754267,43754264,43754258,43754252,43754245,43754235,43754224,43754213,43754211,43754192,43754188,43754184,43754183,43754167,43754165,43754144,43754124,43754105,43754101,43754096,43754094,43754084,43754054,43754046,43754040,43754035,43754032,43754031,43754004,43754001,43753966,43753955,43753941,43753935,43753933,43753917,43753893,43753885,43753878,43753856,43753854,43753842,43753839,43753829,43753825,43753809,43753800,43753790,43753778,43753767,43753755,43753747,43753738,43753735,43753729,43753724,43753720,43753717,43753695,43753689,43753687,43753685,43753681,43753680,43753679,43753677,43753674,43753665,43753652,43753651,43753647,43753627,43753626,43753622,43753621,43753599,43753582,43753567,43753566,43753555,43753513,43753511,43753499,43753493,43753473,43753459,43753435,43753434,43753429,43753427,43753425,43753419,43753416,43753407,43753404,43753403,43753383,43753295,43753281,43753257,43753242,43753240,43753236,43753229,43753228,43753206,43753193,43753180,43753170,43753149,43753119,43753117,43753095,43753090,43753080,43753060,43753057,43753054,43753041,43753039,43753032,43753031,43753012,43753007,43752999,43752990,43752970,43752956,43752954,43752944,43752931,43752911,43752902,43752872,43752871,43752845,43752844,43752836,43752827,43752782,43752740,43752738,43752728,43752697,43752690,43752661,43752646,43752640,43752633,43752627,43752625,43752616,43752604,43752602,43752600,43752599,43752591,43752589,43752579,43752575,43752553,43752546,43752535,43752532,43752504,43752492,43752490,43752486,43752476,43752472,43752467,43752451,43752433,43752429,43752424,43752414,43752397,43752392,43752386,43752372,43752367,43752353,43752337,43752335,43752321,43752262,43752255,43752213,43752211,43752206,43752200,43752191,43752176,43752158,43752152,43752144,43752119,43752118,43752107,43752095,43752073,43752069,43752068,43752067,43752062,43752050,43752049,43752029,43752024,43752009,43751945,43751933,43751929,43751920,43751919,43751891,43751876,43751850,43751828,43751823,43751820,43751804,43751801,43751796,43751792,43751780,43751777,43751763,43751730,43751726,43751723,43751721,43751703,43751681,43751679,43751635,43751599,43751554,43751536,43751530,43751514,43751509,43751501,43751460,43751391,43751388,43751365,43751347,43751332,43751325,43751320,43751313,43751296,43751288,43751287,43751279,43751276,43751253,43751247,43751245,43751242,43751240,43751230,43751217,43751215,43751195,43751177,43751168,43751157,43751135,43751122,43751118,43751101,43751093,43751089,43751076,43751075,43751054,43751050,43751043,43751040,43751037,43751024,43751014,43751009,43751004,43750992,43750986,43750985,43750973,43750969,43750945,43750918,43750892,43750885,43750884,43750878,43750862,43750836,43750795,43750788,43750773,43750765,43750756,43750753,43750709,43750696,43750691,43750681,43750679,43750661,43750651,43750646,43750643,43750617,43750612,43750608,43750573,43750558,43750535,43750489,43750488,43750486,43750475,43750469,43750468,43750439,43750417,43750413,43750390,43750386,43750373,43750368,43750351,43750344,43750314,43750309,43750300,43750299,43750288,43750274,43750241,43750235,43750227,43750220,43750165,43750162,43750154,43750144,43750143,43750139,43750133,43750126,43750116,43750115,43750105,43750098,43750056,43750008,43749999,43749983,43749952,43749951,43749949,43749945,43749929,43749923,43749920,43749912,43749899,43749880,43749877,43749852,43749838,43749822,43749813,43749805,43749801,43749795,43749771,43749731,43749703,43749689,43749677,43749641,43749637,43749592,43749577,43749571,43749564,43749559,43749554,43749550,43749498,43749495,43749475,43749449,43749428,43749405,43749382,43749362,43749320,43749303,43749299,43749283,43749276,43749271,43749254,43749250,43749229,43749222,43749178,43749168,43749166,43749125,43749106,43749104,43749097,43749096,43749094,43749084,43749073,43749070,43749054,43749052,43749039,43749018,43749013,43749011,43748979,43748966,43748959,43748955,43748903,43748895,43748883,43748829,43748810,43748750,43748706,43748653,43748629,43748580,43748553,43748539,43748512,43748505,43748502,43748500,43748487,43748486,43748479,43748470,43748458,43748447,43748414,43748412,43748402};
		_repository.ReadNewStories().Returns(data);
		_repository.GetStoryById(Arg.Any<int>()).Returns(x => 
		{
			var item = Substitute.For<HackerNewsItem>();
			item.Id = (int)x[0]; 
			return item;
		});
		var service = new HackerNewsService(_logger, _repository, new HNMemoryCache());

		var response = await service.GetStoryCount("");
		
		Assert.IsType<int>(response);
		Assert.Equal(data.Count, response);
	}

	[Fact]
	public async Task GetNewStories_ReturnsList()
	{
		var data = new List<int>{43754762,43754752,43754749,43754748,43754739,43754730,43754700,43754666,43754657,43754652,43754620,43754613,43754609,43754607,43754606,43754568,43754566,43754548,43754534,43754524,43754516,43754492,43754487,43754445,43754439,43754438,43754434,43754426,43754408,43754407,43754396,43754389,43754383,43754368,43754366,43754335,43754319,43754299,43754281,43754280,43754274,43754272,43754267,43754264,43754258,43754252,43754245,43754235,43754224,43754213,43754211,43754192,43754188,43754184,43754183,43754167,43754165,43754144,43754124,43754105,43754101,43754096,43754094,43754084,43754054,43754046,43754040,43754035,43754032,43754031,43754004,43754001,43753966,43753955,43753941,43753935,43753933,43753917,43753893,43753885,43753878,43753856,43753854,43753842,43753839,43753829,43753825,43753809,43753800,43753790,43753778,43753767,43753755,43753747,43753738,43753735,43753729,43753724,43753720,43753717,43753695,43753689,43753687,43753685,43753681,43753680,43753679,43753677,43753674,43753665,43753652,43753651,43753647,43753627,43753626,43753622,43753621,43753599,43753582,43753567,43753566,43753555,43753513,43753511,43753499,43753493,43753473,43753459,43753435,43753434,43753429,43753427,43753425,43753419,43753416,43753407,43753404,43753403,43753383,43753295,43753281,43753257,43753242,43753240,43753236,43753229,43753228,43753206,43753193,43753180,43753170,43753149,43753119,43753117,43753095,43753090,43753080,43753060,43753057,43753054,43753041,43753039,43753032,43753031,43753012,43753007,43752999,43752990,43752970,43752956,43752954,43752944,43752931,43752911,43752902,43752872,43752871,43752845,43752844,43752836,43752827,43752782,43752740,43752738,43752728,43752697,43752690,43752661,43752646,43752640,43752633,43752627,43752625,43752616,43752604,43752602,43752600,43752599,43752591,43752589,43752579,43752575,43752553,43752546,43752535,43752532,43752504,43752492,43752490,43752486,43752476,43752472,43752467,43752451,43752433,43752429,43752424,43752414,43752397,43752392,43752386,43752372,43752367,43752353,43752337,43752335,43752321,43752262,43752255,43752213,43752211,43752206,43752200,43752191,43752176,43752158,43752152,43752144,43752119,43752118,43752107,43752095,43752073,43752069,43752068,43752067,43752062,43752050,43752049,43752029,43752024,43752009,43751945,43751933,43751929,43751920,43751919,43751891,43751876,43751850,43751828,43751823,43751820,43751804,43751801,43751796,43751792,43751780,43751777,43751763,43751730,43751726,43751723,43751721,43751703,43751681,43751679,43751635,43751599,43751554,43751536,43751530,43751514,43751509,43751501,43751460,43751391,43751388,43751365,43751347,43751332,43751325,43751320,43751313,43751296,43751288,43751287,43751279,43751276,43751253,43751247,43751245,43751242,43751240,43751230,43751217,43751215,43751195,43751177,43751168,43751157,43751135,43751122,43751118,43751101,43751093,43751089,43751076,43751075,43751054,43751050,43751043,43751040,43751037,43751024,43751014,43751009,43751004,43750992,43750986,43750985,43750973,43750969,43750945,43750918,43750892,43750885,43750884,43750878,43750862,43750836,43750795,43750788,43750773,43750765,43750756,43750753,43750709,43750696,43750691,43750681,43750679,43750661,43750651,43750646,43750643,43750617,43750612,43750608,43750573,43750558,43750535,43750489,43750488,43750486,43750475,43750469,43750468,43750439,43750417,43750413,43750390,43750386,43750373,43750368,43750351,43750344,43750314,43750309,43750300,43750299,43750288,43750274,43750241,43750235,43750227,43750220,43750165,43750162,43750154,43750144,43750143,43750139,43750133,43750126,43750116,43750115,43750105,43750098,43750056,43750008,43749999,43749983,43749952,43749951,43749949,43749945,43749929,43749923,43749920,43749912,43749899,43749880,43749877,43749852,43749838,43749822,43749813,43749805,43749801,43749795,43749771,43749731,43749703,43749689,43749677,43749641,43749637,43749592,43749577,43749571,43749564,43749559,43749554,43749550,43749498,43749495,43749475,43749449,43749428,43749405,43749382,43749362,43749320,43749303,43749299,43749283,43749276,43749271,43749254,43749250,43749229,43749222,43749178,43749168,43749166,43749125,43749106,43749104,43749097,43749096,43749094,43749084,43749073,43749070,43749054,43749052,43749039,43749018,43749013,43749011,43748979,43748966,43748959,43748955,43748903,43748895,43748883,43748829,43748810,43748750,43748706,43748653,43748629,43748580,43748553,43748539,43748512,43748505,43748502,43748500,43748487,43748486,43748479,43748470,43748458,43748447,43748414,43748412,43748402};
		var page = 0;
		_repository.ReadNewStories().Returns(data);
		_repository.GetStoryById(Arg.Any<int>()).Returns(x => 
		{
			var item = Substitute.For<HackerNewsItem>();
			item.Id = (int)x[0]; 
			return item;
		});
		var service = new HackerNewsService(_logger, _repository, new HNMemoryCache());

		var response = await service.GetNewStories(page);

		Assert.IsType<List<NewsStory>>(response);
		Assert.Equal(itemsPerPage, response.Count);
		for(var i = itemsPerPage*page; i<response.Count + itemsPerPage*page; i++)
		{
			Assert.Equal(data[i], response[i].Id);
		}
	}

}